# ðŸš€ Cloudflare Deployment Checklist

Complete checklist for deploying XFlex Trading Academy to Cloudflare.

---

## Phase 1: Code Preparation âœ… DONE

- [x] Create `wrangler.toml` with D1 & R2 bindings
- [x] Migrate schema from PostgreSQL to SQLite (`schema-sqlite.ts`)
- [x] Update `drizzle.config.ts` for SQLite dialect
- [x] Update `server/db.ts` for D1 connection
- [x] Create `server/_core/worker.ts` for Workers handler
- [x] Create `server/storage-r2.ts` for R2 uploads
- [x] Update `server/_core/env.ts` for Cloudflare environment
- [x] Update `package.json` with new scripts & dependencies
- [x] Create comprehensive documentation

---

## Phase 2: Build & Installation (Next)

- [ ] Run: `npm install`
- [ ] Verify build: `npm run build`
- [ ] Check `dist/` folder exists with:
  - [ ] `dist/public/` (React app)
  - [ ] `dist/index.js` (Express bundle)

**Estimated time**: 10-15 minutes

---

## Phase 3: Cloudflare Setup

### 3a: Environment Secrets

- [ ] Generate JWT secret: `openssl rand -base64 32`
- [ ] Set secrets via CLI or Dashboard:
  - [ ] `JWT_SECRET`
  - [ ] `OAUTH_SERVER_URL`
  - [ ] `VITE_OAUTH_PORTAL_URL`
  - [ ] `VITE_APP_ID`
  - [ ] `OWNER_OPEN_ID`
  - [ ] `OWNER_NAME`
  - [ ] `VITE_APP_TITLE`
  - [ ] `VITE_APP_LOGO`
  - [ ] `BUILT_IN_FORGE_API_URL`
  - [ ] `BUILT_IN_FORGE_API_KEY`
  - [ ] `VITE_FRONTEND_FORGE_API_URL`
  - [ ] `VITE_FRONTEND_FORGE_API_KEY`

Command:
```bash
wrangler secret put JWT_SECRET --env production
# Repeat for each secret
```

**Estimated time**: 5-10 minutes

### 3b: Database Initialization

- [ ] Generate Drizzle migrations: `npm run db:generate`
- [ ] Check `drizzle/` folder for new migration files
- [ ] Apply migrations to D1:
  ```bash
  wrangler d1 execute xflexwithai-db --file=./drizzle/0000_*.sql --env production
  ```
- [ ] Verify database: `wrangler d1 info xflexwithai-db --env production`

**Estimated time**: 5-10 minutes

### 3c: Domain Setup

- [ ] Ensure `xflexwithai.com` is registered with Cloudflare
- [ ] Add DNS records:
  - [ ] A record: `xflexwithai.com` â†’ Cloudflare Pages IP
  - [ ] CNAME: `api.xflexwithai.com` â†’ `xflexwithai.workers.dev`
- [ ] (Optional) Add SSL/TLS certificate (auto-generated by Cloudflare)

**Estimated time**: 5 minutes

---

## Phase 4: Deployment

### 4a: Deploy Backend (Workers)

```bash
wrangler deploy --env production
```

- [ ] Command succeeds without errors
- [ ] Deployment URL provided (e.g., `https://xflexwithai.workers.dev`)

**Estimated time**: 2-3 minutes

### 4b: Deploy Frontend (Pages)

```bash
wrangler pages publish dist/public --project-name=xflexwithai
```

- [ ] Command succeeds without errors
- [ ] Project URL provided

**Estimated time**: 2-3 minutes

---

## Phase 5: Verification

### 5a: Check Deployments

- [ ] Workers dashboard shows deployment
- [ ] Pages dashboard shows deployment
- [ ] Both show "Active" status

### 5b: Test API

```bash
# Test health endpoint
curl https://api.xflexwithai.com/api/health

# Should return 200 OK
```

- [ ] API responds with 200 OK
- [ ] No 502 Bad Gateway errors

### 5c: Test Frontend

- [ ] Visit: `https://xflexwithai.com`
- [ ] Page loads without 404 errors
- [ ] Styles/CSS loads correctly
- [ ] JavaScript executes (no console errors)

### 5d: Test Database

```bash
wrangler d1 execute xflexwithai-db --command="SELECT COUNT(*) FROM users" --env production
```

- [ ] Query succeeds
- [ ] Returns result (even if empty)

### 5e: Test R2 Bucket

```bash
wrangler r2 ls xflexwithai-videos/
```

- [ ] Lists files in R2 bucket
- [ ] Shows your uploaded videos

**Estimated time**: 10-15 minutes

---

## Phase 6: Functionality Testing

### 6a: Authentication

- [ ] User registration works
- [ ] User login works
- [ ] JWT token is set in cookies
- [ ] Logout clears cookies

### 6b: Courses

- [ ] Can see published courses
- [ ] Can view course details
- [ ] Can view course episodes
- [ ] Can watch course videos

### 6c: Admin Panel

- [ ] Can access admin login
- [ ] Can log in as admin
- [ ] Can see dashboard
- [ ] Can manage courses
- [ ] Can manage episodes
- [ ] Can manage keys

### 6d: Registration Keys

- [ ] Can create registration keys
- [ ] Can activate key with email
- [ ] Key unlocks course enrollment

### 6e: Quiz System

- [ ] Quiz questions load
- [ ] Can submit answers
- [ ] Score calculates correctly
- [ ] Progress updates

**Estimated time**: 30-60 minutes

---

## Phase 7: Performance & Monitoring

- [ ] Check Cloudflare Analytics
- [ ] Monitor Worker execution time
- [ ] Check error rates
- [ ] Review D1 database queries
- [ ] Monitor R2 bandwidth

Commands:
```bash
wrangler tail --env production         # Live logs
wrangler analytics engine --env prod   # Performance metrics
```

---

## Phase 8: Go Live

- [ ] All tests passing
- [ ] No error logs
- [ ] Performance acceptable
- [ ] DNS is fully propagated (48 hours)
- [ ] SSL certificate is valid
- [ ] Announce to users!

---

## Rollback Plan (If Needed)

If something goes wrong:

```bash
# Rollback Workers
wrangler rollback --env production

# Rollback Pages
# Go to Pages Dashboard â†’ Deployments â†’ Rollback

# Restore from backup
# D1: Export data from working database
# R2: Objects are immutable, but you can delete/restore
```

---

## Useful Commands

```bash
# Build
npm run build

# Deploy
wrangler deploy --env production
wrangler pages publish dist/public --project-name=xflexwithai

# Monitor
wrangler tail --env production

# Database
npm run db:generate
npm run db:push
wrangler d1 execute xflexwithai-db --command="..." --env production

# R2
wrangler r2 ls xflexwithai-videos/
wrangler r2 object upload xflexwithai-videos test.txt

# Secrets
wrangler secret put SECRET_NAME --env production
wrangler secret list --env production
```

---

## Support Resources

- [Cloudflare Workers Docs](https://developers.cloudflare.com/workers/)
- [D1 Database Guide](https://developers.cloudflare.com/d1/)
- [R2 Bucket Guide](https://developers.cloudflare.com/r2/)
- [Wrangler CLI](https://developers.cloudflare.com/workers/wrangler/install-and-update/)
- [Drizzle ORM SQLite](https://orm.drizzle.team/docs/get-started-sqlite)

---

## Timeline Estimate

- Phase 1 (Code Prep): âœ… Done
- Phase 2 (Build): ~15 mins
- Phase 3 (Setup): ~20 mins
- Phase 4 (Deploy): ~5 mins
- Phase 5 (Verify): ~15 mins
- Phase 6 (Test): ~45 mins
- **Total**: ~2 hours (mostly testing)

---

## Success Indicators

âœ… **Success** when all of these are true:

1. Frontend loads at `https://xflexwithai.com`
2. API responds at `https://api.xflexwithai.com/api/...`
3. Can create user account
4. Can view courses
5. Can view admin panel
6. Database stores and retrieves data
7. R2 serves videos
8. No console errors
9. No 502/404 errors

---

## Questions?

See the documentation files:
- [MIGRATION_COMPLETE.md](MIGRATION_COMPLETE.md) - Overview
- [CLOUDFLARE_DEPLOYMENT_STEPS.md](CLOUDFLARE_DEPLOYMENT_STEPS.md) - Detailed guide
- [CLOUDFLARE_STEP2_ENV_SETUP.md](CLOUDFLARE_STEP2_ENV_SETUP.md) - Environment setup

---

**You've got this!** ðŸš€ Start with Phase 2: `npm install`
